{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block head_title %}
    Создать новость
{% endblock head_title %}
{% load ttags %}
{% load staticfiles %}
{% block content %}
<a id="go-back-btn-before"  href='{%if post%}{{post.get_absolute_url}}{%else%}{%url "main:blog"%}{%endif%}'>
    <i class="arrow left icon"></i>
</a>
<div class='ui container pb150 pt15'>
    <div class="ui grid stackable">
        {% include 'left_menu.html' %}
        <div class="w85 wide column mlback">
            <div class="ui grid stackable no_margin">
                <div class="eight wide column no_padding">
                    <div class="ui segment shadow_small">
                        <form class="ui form mb0">
                            <div class="textdg mb5">
                                <span style="display: none;" class="newpost_notitle highlight_red">Введите заголовок</span>
                            </div>
                            <textarea class="text17 mb5 newpost_title" placeholder="Заголовок">{%if post%}{{post.title}}{%endif%}</textarea>
                            <div class="dflex">
                                <a class="pt5 pb5 ui button white border1 shadow_small save_post" url="{% url 'news:save_post' %}" id="{%if post%}{{post.id}}{%else%}-1{%endif%}">
                                    <i class="icon check blue mr0"></i>
                                    <div class="create_post_loader ui active inline mini loader" style="display: none;"></div>
                                </a>                                
                            </div>   
                        </form>                     
                    </div>
                    <div class="ui mb0">
                        <form class="ui form text13 mb0">
                            <div style="display: none;">
                                <div class="pb5 mt0 mb10 part_edit_orig ui segment shadow_small"></div>
                                <textarea class="edit_text_orig partcontent mb0"></textarea>
                                <div class="edit_img_orig mt10">
                                    <b>Картинка</b> <span class="file_name_orig"></span>
                                    <input type="file" name="part_file{{part.id}}" id="part_file{{part.id}}" class="input_file_orig part_file{{part.id}} postfile">
                                    <label class="label_file_orig part_file{{part.id}}" for="part_file{{part.id}}">
                                        <a class="ui button mini white shadow_small border1 pl10 pr10"><i class="icon upload textdg"></i> Выбрать другую</a>
                                    </label>   
                                </div>
                                <div class="edit_file_orig part_file{{part.id}} ui segment shadow_small no_margin">
                                    <b>Файл</b> <span class="file_name_orig"></span>
                                    <input type="file" name="part_file{{part.id}}" id="part_file{{part.id}}" class="input_file_orig part_file{{part.id}} postfile">
                                    <label class="label_file_orig part_file{{part.id}}" for="part_file{{part.id}}">
                                        <a class="ui button mini white shadow_small border1 pl10 pr10"><i class="icon upload textdg"></i> Выбрать другую</a>
                                    </label>   
                                </div>
                                <div class="dflex mt5 part_buttons_orig">
                                    <a class="pt5 pb5 ui button white border1 shadow_small post_add_part">
                                        <i class="icon check blue mr0"></i>
                                        <div class="create_post_loader ui active inline mini loader" style="display: none;"></div>
                                    </a>
                                    <a class="pt5 pb5 ui button white border1 shadow_small post_delete_part"><i class="icon x red mr0"></i></a>
                                </div>                                
                            </div>                                   
                            <div class="post_cont">
                            {%if post%}
                                {%for part in post.parts.all%}
                                <div class="pb5 mt0 mb10 part_edit{{part.id}} ui segment shadow_small">
                                    {% if part.content|length > 0 %}
                                    <textarea id="{{part.id}}" class="mb0 part_content{{part.id}}" oninput="fill_pred_text('{{part.id}}')">{{ part.content }}</textarea>
                                    <span style="display: none;" class="parttextof{{part.id}}" text=""></span>
                                    {% endif %}
                                    {% if part.image %}
                                    <div class="part_img{{part.id}} no_margin">
                                        <b>Картинка</b> {{part.image}}
                                        <input type="file" name="part_file{{part.id}}" id="part_file{{part.id}}" class="part_file{{part.id}} postfile">
                                        <label class="part_file{{part.id}}" for="part_file{{part.id}}">
                                            <a class="ui button mini white shadow_small border1 pl10 pr10"><i class="icon upload textdg"></i> Выбрать другую</a>
                                        </label>   
                                    </div>
                                    {% endif %}
                                    {% if part.file %}
                                    <div class="part_file{{part.id}} ui segment shadow_small no_margin">
                                        <b>Файл</b> {{part.file}}
                                        <a class="ui button mini white border1 shadow_small"><i class="icon upload textdg"></i> Выбрать другую</a>
                                    </div>
                                    {%endif%}  
                                    <div class="mt5 dflex">
                                        <a onclick="post_add_part('{{part.id}}')" class="pt5 pb5 ui button white border1 shadow_small post_add_part" id="{{part.id}}">
                                            <i class="icon check blue mr0"></i>
                                            <div class="create_post_loader ui active inline mini loader" style="display: none;"></div>
                                        </a>
                                        <a class="pt5 pb5 ui button white border1 shadow_small post_delete_part" onclick="post_delete_part('{{part.id}}')" id="{{part.id}}"><i class="icon x red mr0"></i></a>
                                    </div>  
                                </div>
                                {% endfor %}
                            {%endif%}
                            </div>
                        </form>                        
                    </div>
                    <div class="ui segment backgreenlow mt0">
                        <div class="full-w text15 mb5 textdg">
                            <b>Добавить блок</b>
                        </div>
                        <div class="dflex">
                            <div class="pl0" style="width: calc(100% - 40px);">
                                <form class="ui form mb0 full-w">
                                    <textarea id="-1" oninput="fill_pred_text('-1')" class="mb0 newpost_text part_content-1" style="height: 150px;padding-top: 11px;" placeholder="Введите текст"></textarea>
                                    <span style="display: none;" class="parttextof-1" text=""></span>
                                </form>
                            </div>
                            <div class="ml5">
                                <input type="file" name="part_file-1" id="part_file-1" part_id="-1" class="postfile">
                                <label class="part_file-1" for="part_file-1">
                                    <a class="ui button mini white shadow_small pl10" style="padding-right: 7px;"><i class="icon paperclip blue mr0 text15"></i></a>
                                </label>
                                <br>
                                <a onclick="post_add_part('-1')" id="-1" class="mt5 ui button mini white shadow_small pl10 post_add_part" style="padding-right: 7px;">
                                    <i class="icon check mr0 blue text15"></i> 
                                    <div class="create_post_loader ui active inline mini loader" style="display: none;">
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="backgreenlow ui segment mt0" style="min-height: 45px;">
                        <div class="text15 mb15 textdg">
                            <b>Предпросмотр</b>
                        </div>
                        <div class="pred_part_content-1"></div>
                        <img style="max-width: 70px;" class="pred_part_img-1" src="">
                        <a style="display: none;" class="pred_part_file-1 full-w ui button mini white shadow_small"><i class="icon download blue"></i> File</a>
                        <br>
                        <a style="display: none;" id="-1" class="clear_input_file-1 clear_input_file ui button mini white shadow_small mt5 pt5 pb5"><i class="icon x red mr0"></i></a>
                    </div>    
                    <div class="ui segment shadow_small">
                        <div class="textdg mr5">Размер превью:</div>
                        <form class="ui form mb0">
                            <input style="width: 50px;height: 24px" type="number" class="newpost_priority pl5 pr0 mr10 pb0 pt0 shadow_small" value="{%if post%}{{post.priority}}{%else%}1{%endif%}" name="">
                        </form>
                    </div>                
                </div>
                <div class="eight wide column pt0">
                    <div class="mb0 ui segment shadow_small">
                        <div class="text15 mb15 textdg">
                            <b>Так выглядит пост</b>
                        </div>
                        <div class="mb15">
                            <b style="font-size: 24px;"><i class="pred_title">{% if post%}{{post.title}}{%else%}Заголовок{%endif%}</i></b>
                            {%if post%}
                            <div class="textg text15 mt10">
                                {{post.author_profile.first_name}}
                                <span class="ml15">{{post.timestamp}}</span>
                            </div>
                            {%endif%}
                        </div>
                        <div class="empty_post text-center" style="height: 200px;padding-top: 50px;{%if post%}display: none;{%endif%}">
                            <span style="color:grey">Пока пусто</span>
                        </div>
                        <div style="display: none;">
                            <div class="pred_part_orig mb15"></div>
                            <div class="pred_text_orig mb10"></div>
                            <img class="pred_img_orig mb10 half-w" src="">
                            <a href="" class="pred_file_orig full-w ui button mini white border1 shadow_small text15"><i class="icon download textblue"></i> {{part.file}}</a>
                        </div>
                        <div class="pred_cont" style="min-height: 200px;">
                            {% include 'news/post_detail_work.html' %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<style type="text/css">
    textarea{
        overflow-y:hidden;
        border: none !important;
        padding-left: 0 !important;
    }
</style>
<span style="display: none;" class="data" save_part="{%url 'news:post_add_part'%}" delete_part="{% url 'news:post_delete_part' %}" temp_part_id=''></span>
<script type="text/javascript">
    function fill_pred_text(id){
        textarea = $('.part_content'+id)
        val = textarea.val()
        val = val.replace(/\n/g,'<br>')
        $('.pred_part_content'+id).html(val)
        height = textarea.prop('scrollHeight') - 19
        textarea.height(height)        
    }
    $('.clear_input_file').click(function(e) {
        id = $(this).attr('id')
        $('#part_file'+id).val('')
        $(this).hide()
        $('.pred_part_file'+id).hide()
        $('.pred_part_img'+id).hide()
    })
    $('.postfile').change(function() {
        id = $(this).attr('part_id') 
        readURL(this, id);
    })
    function readURL(input, id) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            console.log('totototo')        
            reader.onload = function(e) {
                $('.clear_input_file'+id).show()
                if (e.target.result.indexOf("image") >= 0){
                    $('.pred_part_img'+id).attr('src', e.target.result);
                    $('.pred_part_file'+id).hide()
                    $('.pred_part_img'+id).show()
                }
                else{
                    $('.pred_part_img'+id).attr('src', "");
                    $('.pred_part_file'+id).show()
                }
            }
            reader.readAsDataURL(input.files[0]); // convert to base64 string
        }
    }
    ts = document.getElementsByTagName('textarea')
    for(var i=0; i < ts.length; i++){
        auto_grow_f(ts[i])
    }
    $('textarea').keyup(function(e) {
        if (e.keyCode == 8) {
            auto_grow($(this))
        }
        else{
            height = $(this).prop('scrollHeight') - 19
            $(this).height(height)
        }
    })
    function auto_grow(element){
        text = element.val()
        l = 16
        var count = (text.match(/\n/g) || []).length + 1;
        height = count * l
        element.height(height)
        element.height(element.prop('scrollHeight') - 17)
    }
    function auto_grow_f(element) {
        val = element.value
        val = val.replace(/<br>/g,'\n')
        element.value = val
        element.style.minHeight = element.scrollHeight+"px"            
    }
    function post_delete_part(id){
        console.log('run delete_part')
        url = $('.data').attr('delete_part')
        $.ajax({
            url: url,
            data: {
                'id':id,
            },
            dataType: 'json',
            success: function (data) {
                console.log('0', data.ok)
                if (data.ok) {
                    console.log('1//')
                    $('.pred_part'+id).hide('fast')
                    $('.part_edit'+id).hide('fast')                    
                }
            }
        })
    }
    function post_add_part(init_part_id){
        init_url = $('.data').attr('save_part')
        post_id = $('.save_post').attr('id')
        title = $('.newpost_title').val()
        priority = $('.newpost_priority').val()
        $('.newpost_notitle').hide()
        if (title) {
            $('.create_post_loader').show()
            $('.newpost_saved').hide()
            $('.check').hide()
            alltext = $('.pred_part_content'+init_part_id).html()
            alltext2 = alltext
            if (init_part_id == '-1') {
                $('.newpost_text').val("")
                $('.pred_text').text('')
            }
            texts = []
            cnt = 0
            while(cnt <= parseInt(alltext2.length/500)){
                cnt += 1
                ptext = alltext.substr(0, 500)
                texts.push(ptext)
                alltext = alltext.substr(500)
            }
            if (texts.length == 0) {texts = ['']}
            part_id = init_part_id
            sendTexts(0, texts, part_id,init_part_id, post_id, title, init_url, priority)
        }
        else{
            $('.newpost_notitle').show('fast')
        }
    }
    function sendTexts(i, texts, part_id, init_part_id, post_id, title, init_url, priority){
        text = texts[i]
        add_data = '?id='+part_id+'&post_id='+post_id+'&title='+title+'&priority='+priority+'&text='+text
        if (i == 0) {
            var formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            if ($('#part_file'+init_part_id).length > 0) {
                file = $('#part_file'+init_part_id)[0].files[0];
                formData.append('file', file);
            }            
        }
        else{
            var formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        }
        if (i == texts.length - 1) {is_last = 'yes'}else{is_last = 'no'}
        if(i == 0){is_first = 'yes'}else{is_first='no'}
        add_data += '&first='+is_first+'&last='+is_last
        url = init_url + add_data
        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
                if (post_id == '-1') {
                    window.location.replace(data.url);
                }

                part_id = data.part_id
                if (i == texts.length - 1) {
                    file_url = data.file_url
                    file_name = data.file_name
                    fillPred(post_id, part_id, init_part_id, alltext2, file_url, file_name)
                }
                if (i < texts.length - 1) {
                    i += 1
                    sendTexts(i, texts, part_id,init_part_id, post_id, title, init_url,priority)
                }
            }
        })
    }
    function fillPred(post_id, part_id, init_part_id, alltext2, file_url, file_name){
        console.log('init_part_id',init_part_id)       
            clear_pred()
            if (init_part_id == '-1') {
                part_edit_div = $('.part_edit_orig').clone()
                part_edit_div.removeClass('part_edit_orig')
                part_edit_div.addClass('part_edit'+part_id)
                part_edit_div.appendTo('.post_cont')
                pred_part_div = $('.pred_part_orig').clone()
                pred_part_div.removeClass('pred_part_orig')
                pred_part_div.addClass('pred_part'+part_id)
                pred_part_div.appendTo('.post_box')
            }
            else{
                part_edit_div = $('.part_edit'+part_id)
                pred_part_div = $('.pred_part'+part_id)
            }
            if (text) {
                if (init_part_id == '-1') {
                    text_div = $('.pred_text_orig').clone()
                    text_div.removeClass('pred_text_orig')
                    text_div.addClass('pred_part_content'+part_id)
                    text_edit = $('.edit_text_orig').clone()
                    text_edit.removeClass('edit_text_orig')
                    text_edit.attr('oninput','fill_pred_text('+part_id+')')
                    text_edit.addClass('part_content'+part_id)
                    text_div.appendTo(pred_part_div)
                    text_edit.appendTo(part_edit_div)
                }
                else{
                    text_div = $('.pred_part_content'+part_id)
                    text_edit = $('.part_content'+part_id)
                }
                text_div.html(alltext2)
                text = alltext2.replace(/<br>/g,'\n')
                text_edit.val(text)
                element = $('.part_content'+part_id)
                auto_grow(element)
            }
            if (file_url) {
                if (file_url.length > 0) {                    
                    console.log('img')
                    if (init_part_id != '-1') {
                        img = $('.pred_part_img'+part_id)
                    }
                    else{
                        img_edit = $('.edit_img_orig').clone()
                        img_edit.removeClass('edit_img_orig')
                        img_edit.find('.edit_img_name').text(file_name)
                        img_edit.appendTo(part_edit_div)
                        img_edit.attr('id', part_id)                        
                        img = $('.pred_img_orig').clone()
                        img.removeClass('pred_img_orig')
                        img.addClass('pred_part_img'+part_id)
                        img.appendTo(pred_part_div)
                    }
                    img.attr("src", file_url)
                    img.load(document.URL +  '.pred_part_img'+part_id);
                }
            }
            if (init_part_id == '-1') {
                btns = $('.part_buttons_orig').clone()
                btns.removeClass('part_buttons_orig')
                btns.find('.post_add_part').attr('onclick', "post_add_part('"+part_id+"')")
                btns.find('.post_delete_part').attr('onclick', "post_delete_part('"+part_id+"')")
                btns.appendTo(part_edit_div)
            }
        
    }
    function clear_pred(){
        $('.save_post').addClass('disabled')
        $('.save_post').removeClass('blue')
        $('.create_post_loader').hide()
        $('.check').show()
        $('.newpost_saved').show()
        $('.empty_post').hide()
        $('.pred_part_content-1').html("")
        $('.pred_part_img-1').attr('src', "");
    }
</script>
{% endblock content %}