{% load static %}
<script type="text/javascript">
    get_post()
    function get_post(){
        console.log('get_post')
        url = $('.data').attr('get_post_url')
        id = $('.data').attr('id')
        $.ajax({
            url: url,
            data: {
                'id':id,
            },
            dataType: 'json',
            success: function (data) {
                content = data.content.replace('(', '<').replace(')', '>')
                $('.post_content').html(content)
                $('.post_for_save').html(content)
                console.log(data.content)
                for (var i = 0; i < data.images.length; i++) {
                    img_url = data.images[i][0]
                    part_id = data.images[i][1]
                    order = data.images[i][2]
                    img = $('.img_orig').clone()
                    img.removeClass('img_orig')
                    img.attr('src', img_url)
                    img.attr('ondragstart', 'save_drag_id('+part_id+')')
                    img.addClass('file_alr post_file'+part_id)
                    img.attr('id', part_id)
                    if (order < 0) {
                        place = $('.file_box'+order)
                    }
                    else{                        
                        place = $('.file_box'+part_id)
                    }
                    img.insertBefore(place)
                    place.remove()
                }
            }
        })
    }
    function save_drag_id(id){
        $('.data').attr('drag_file_id', id)
    }
    async function save_post(){
        await replace_images()
        save_post_work()
    }
    async function replace_images(){
        $('.post_for_save').html($('.post_content').html())
        $('.post_for_save').find('.post_file').each(function(){
            this_ = $(this)
            $('<div class="file_box file_box'+this_.attr('id')+'"></div>').insertBefore(this_)
            this_.remove()
        })
    }
    async function save_post_work(id, slug){
        this_ = $('.save_post')
        this_.addClass('disabled')
        id = this_.attr('id')
        content = $('.post_for_save').html().replace(';', ' ').replace('<', '(').replace('>', ')')
        $('.create_post_loader').show()
        $('.newpost_saved').hide()
        url = this_.attr('url')
        //*******************
        texts = []
        cnt = 0
        len = content.length
        console.log('delenie: '+len/500)
        if (len % 500 == 0) {len -= 1}
        while(cnt <= parseInt(len/500)){
            console.log('cnt', cnt)
            cnt += 1
            ptext = content.substr(0, 500)
            console.log('ptext', ptext)
            texts.push(ptext)
            content = content.substr(500)
        }
        if (texts.length == 0) {texts = ['']}
        sendTexts(0, texts, id, url)
    }
    function sendTexts(i, texts, id, init_url){
        console.log('send', i)
        text = texts[i]
        if (i == 0) {
            old_files = []
            $('.file_alr').each(function(){
                old_files.push(parseInt($(this).attr('id')))
            })
            slug = this_.attr('slug')        
            title = $('.newpost_title').val()
            priority = $('.newpost_priority').val()
            add_data = '?id='+id+'&title='+title+'&content='+text+'&priority='+priority+'&slug='+slug+'&old_files='+old_files
            var formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            $('.post_input').each(function() {
                file = $('#'+$(this).attr('id'))[0].files[0]
                formData.append($(this).attr('order'), file); 
            })
        }
        else{
            add_data = '?id='+id+'&content='+text
            var formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        }
        if (i == texts.length - 1) {is_last = 'yes'}else{is_last = 'no'}
        if(i == 0){is_first = 'yes'}else{is_first='no'}
        add_data += '&first='+is_first+'&last='+is_last
        url = init_url + add_data
        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
                if (is_last == 'yes' && id=='-1') {
                    window.location.replace(data.url);
                }
                else if (is_last == 'yes'){
                    saved_true()
                }
                else if (i < texts.length - 1) {
                    i += 1
                    sendTexts(i, texts, id, init_url)
                }
            }
        })
    }
    function saved_true(){
        $('.create_post_loader').hide()
        $('.newpost_saved').show()
    }
    function saved_false(){
        $('.create_post_loader').hide()
        $('.newpost_saved').hide()
        $('.save_post').removeClass('disabled')
    }
    $('.post_content').keydown(function(e) {
        if (e.keyCode === 13) {
            document.execCommand('insertHTML', false, '<br><br>');
            return false;
        }
        saved_false()
    });
    $('.post_content').focus()
    function drag_show_box(id){
        $('#'+id).addClass('ui segment shadow')
    }
    function drag_hide_box(id){
        $('#'+id).removeClass('ui segment shadow')
    }
    $('.post_content').on("drop", function(event) {
        drop_file()
        saved_false()
    })
    function drop_file(){
        position = window.getSelection().anchorOffset
        id = parseInt($('.data').attr('drag_file_id'))
        setTimeout(function() {
            file = $('.post_file'+id).first()
            if (id < 0) {
                post_input = $('.postfile').clone()
                post_input.appendTo('.input_box')
                post_input.removeClass('postfile')
                post_input.addClass('post_input')
                post_input.attr('style', 'display:none')
                post_input.attr('id', 'post_input'+id)
                post_input.attr('order', id)
                file.removeClass('new_image')
                file.addClass('post_file'+id)
            }
            $('<br><br>').insertBefore(file)
            $('<br><br>').insertAfter(file)
            window.getSelection().removeAllRanges()
        }, 100);
    }
    $('.newpost_priority').change(function() {
        saved_false()
    })
    $('.postfile').change(function() {
        id = $(this).attr('part_id') 
        preload_image(this, id);
        $('.file_hint').show()
    })
    function preload_image(input, id) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                if (e.target.result.indexOf("image") >= 0){
                    $('.dragarea').show()
                    $('.new_image').attr('src', e.target.result);
                    number = parseInt($('.data').attr('crnt_file_number'))
                    $('.new_image').removeClass('post_file' + (number+1))
                    $('.new_image').addClass('post_file post_file' + number)
                    $('.new_image').attr('id', number)
                    $('.data').attr('crnt_file_number', number-1)
                    $('.new_image').attr('ondragstart', 'save_drag_id('+number+')')
                }
                else{
                    $('.pred_part_img'+id).attr('src', "");
                    $('.pred_part_file'+id).show()
                }
            }
            reader.readAsDataURL(input.files[0]); // convert to base64 string
        }
    }
    var rangeM = 79
    function saveSelection() {
        if (window.getSelection) {
            sel = window.getSelection();
            if (sel.getRangeAt && sel.rangeCount) {
                var ranges = [];
                for (var i = 0; i < sel.rangeCount; ++i) {
                    console.log('sav', i, sel.getRangeAt(i).startOffset, sel.getRangeAt(i).endOffset)
                    ranges.push(sel.getRangeAt(i));
                    $('.data').attr('sel_start', sel.getRangeAt(i).startOffset)
                    $('.data').attr('sel_end', sel.getRangeAt(i).endOffset)
                }
                console.log('0',ranges)
                rangeM = ranges
                return ranges;
            }
        } else if (document.selection && document.selection.createRange) {
            return document.selection.createRange();
        }
        return null;
    }
    function restoreSelection() {
        console.log(rangeM)
        sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(rangeM[0]);        
    }
    function createLink() {
        restoreSelection()
        var url = $('.link_address').val()
        if (url != '' && url) {
            document.execCommand("CreateLink", false, url); 
            $('.link_address').val('')   
            $('.create_link_box').modal('hide')        
        }
    }
</script>
<div class="post_for_save" style="display: none;"></div>
<div style="display: none;">
    <img src="" class="img_orig post_file" style="width: 90%; margin: 0 5%;">    
</div>
