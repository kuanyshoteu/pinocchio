{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block head_title %}
    {{ instance.title }} | {{ block.super }}
{% endblock head_title %}

{% block head_extra %}
    {{ form.media }}
{% endblock head_extra %}
{% load ttags %}
{% load ttttags %}
{% load staticfiles %}

{% block content %}
<div id="group-details" style="padding-bottom: 200px;">
    <div class='ui container'>
        <div class="ui grid">
            {% include 'left_menu.html' %}
            <div class="wide column" style="width: 80%;">
                <div class="ui segment mb0 text15">
                    <b>Оплата студентов</b>
                </div>
                <div class="ui segment no_margin no_padding">
                    <form class="ui form">  
                        <div class="ui grid stackable no_margin">
                            <div class="four wide column pb15">
                                Выберите <b>предмет</b>:
                                <div class="controls"> 
                                    <select class="crm_option" id="crm_subject_mobile" url="{{ instance.crm_option_url }}" option="subject"> 
                                        {% if profile.skill.crm_subject %}
                                            <option value="{{ profile.skill.crm_subject.id }}">{{ profile.skill.crm_subject.title }}</option>
                                        {% endif %}
                                        <option value="-1">Все предметы</option>
                                        {% for subject_category in subject_categories %}
                                            {% if subject_category != profile.skill.crm_subject %}
                                            <option value="{{ subject_category.id }}">{{ subject_category.title }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="four wide column pb15">
                                Выберите <b>возраст</b>:
                                <div class="controls"> 
                                    <select class="crm_option" id="crm_age_mobile" url="{{ instance.crm_option_url }}" option="age"> 
                                        {% if profile.skill.crm_age %}
                                            <option value="{{ profile.skill.crm_age.id }}">{{ profile.skill.crm_age.title }}</option>
                                        {% endif %}
                                        <option value="-1">Все возрасты</option>
                                        {% for subject_age in subject_ages %}
                                            {% if subject_age != profile.skill.crm_age %}
                                            <option value="{{ subject_age.id }}">{{ subject_age.title }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>                            
                            </div>
                            <div class="four wide column ">
                                Выберите <b>группу</b>:
                                <div class="controls"> 
                                    <select class="crm_option" id="crm_squad_mobile" url="{{ instance.crm_option_url }}" option="group"> 
                                        {% if profile.rating_squad_choice.first %}
                                            <option value="{{ profile.rating_squad_choice.first.id }}">{{ profile.rating_squad_choice.first.title }}</option>
                                        {% endif %}
                                        <option value="-1">Все группы</option>
                                        {% for squad in squads %}
                                            {% if squad != profile.rating_squad_choice.first %}
                                            <option value="{{ squad.id }}">{{ squad.title }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>                            
                            </div>
                        </div>
                    </form>
                </div>
                <div class="ui segment no_margin no_padding" id="calendar">
                    <div class="loading" style="display: none;">
                      <div class="animation"><div class="circle one"></div></div>
                      <div class="animation"><div class="circle two"></div></div>
                      <div class="animation"><div class="circle three"></div></div>
                      <div class="animation"><div class="circle four"></div></div>
                      <div class="animation"><div class="circle five"></div></div>
                      <div class="animation"><div class="circle six"></div></div>
                    </div>                            
                    <div class="full-w no_margin backdark">
                    {% for student in profile|rating_filter %}
                        <div class="{% if forloop.counter|is_odd %}backdarklow{% endif %} pt5 pb5 pl15 pr15" style="display: flex;">
                            <div class="pt10" style="text-overflow: ellipsis;white-space: nowrap;overflow: hidden;width: 200px;">
                                <span>{{ forloop.counter }}.</span>
                                <a href="{{ student.0.get_absolute_url }}" class="textw">
                                    <b>{{ student.0.first_name }}</b>
                                </a>
                            </div>
                            {%include 'school/payment_student_form.html' %}
                        </div>
                    {% endfor %}
                    </div>
                </div>
                <div class="ui modal payment_history" style="height: 100%;">
                    <i class="close icon"></i>
                    <div class="content">
                        <div class="text-center mb15">
                            <div style="font-size: 17px;">
                                <b>История оплаты</b>
                            </div>
<!--                             <i style="font-size: 13px;">
                                Можете отменить оплату в течении 3 суток
                            </i>
 -->                        </div>
                        <table style="font-size: 13px;margin: 0 auto">
                            <thead>
                                <tr>
                                    <th class="border">Время</th>
                                    <th class="border">Сумма</th>
                                    <th class="border">Группа</th>
                                    <th class="border">Менеджер</th>
                                </tr>
                            </thead>
                            <tbody class="fill_payment_history">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<span class="data" payday_change_url="{%url 'schools:payday_change'%}" payment_history="{% url 'schools:payment_history' %}"></span>
<script type="text/javascript">
    function make_payment(url, id, group_id) {
        amount = $('.payment_amounts'+id+'g'+group_id).val()
        $('.success_payment').hide()
        $.ajax({
            url: url,
            data: {
                'amount':amount,
                'id':id,
                'group_id':group_id                
            },
            dataType: 'json',
            success: function (data) {
                $('.payment_amounts'+id+'g'+group_id).val('')
                $('.success_payments'+id+'g'+group_id).show()
            }
        })        
    };

    function payment_history(id) {
        url = $('.data').attr('payment_history')
        $.ajax({
            url: url,
            data: {
                'id':id,
            },
            dataType: 'json',
            success: function (data) {
                $('.payment_history').modal('show')
                $('.fill_payment_history').empty()
                for (var i = 0; i < data.res.length; i++) {
                    $('<tr> <td class="border payment_timestamp">'+data.res[i][0]+'</td> <td class="border payment_amount">'+data.res[i][1]+'</td> <td class="border payment_squad">'+data.res[i][2]+'</td> <td class="border"><a class="payment_manager" href="'+data.res[i][3]+'">'+data.res[i][4]+'</a></td> </tr>').appendTo('.fill_payment_history')
                }
            }
        })        
    };

</script>
{% endblock content %}