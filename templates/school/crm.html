{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block head_title %}
    CRM {{ instance.title }}
{% endblock head_title %}
{% block head_extra %}
    {{ form.media }}
{% endblock head_extra %}
{% load ttags %}
{% load ttttags %}
{% load staticfiles %}
{% block content %}
<script src='{% static "js/vue-drag/vue.min.js" %}'></script>
<script src='{% static "js/vue-drag/axios.min.js" %}'></script>
<script src='{% static "js/vue-drag/sortable.min.js" %}'></script>
<script src='{% static "js/vue-drag/vue-draggable.min.js" %}'></script>
<div id="app" style="overflow-y: hidden;height: 90% !important;">
    <div class='ui container' id="untouch" style="height: 100%;">
        <div class="ui grid main_crm" style="margin-top: 0;height: 100%;">
            {% include 'left_menu.html' %}
            <div class="wide column" style="padding-right: 0;width: 85%;">
                <div style="padding-bottom: 8px;">
                    <form class="ui form" method='POST' enctype='multipart/form-data'>{% csrf_token %}
                        <div class="ui grid">
                            <div class="three wide column pl5 pr0 pb0">
                                <input type="text" id="search_text" placeholder="Поиск по карточкам">
                                <div class="search_hint ui segment" style="display: none;"></div>                               
                            </div>
                            <div class="wide column pl0 pb0" style="width: 28.13px;">
                                <button class="ui button small blue search_by_tags" type="submit" onclick="return false"><i class="icon search" style="color: white;"></i></button>
                            </div>
                            {%if not crm_all%}
                            <div class="wide column pb0" style="width: 155px;">
                                <div class="ui toggle checkbox segment" style="padding: 4px 5px;margin-top: 1px;">
                                  <input type="checkbox" {% if theprofile.skill.crm_show_free_cards %}checked{% endif%} class="show_free_cards" url="{{ instance.show_free_cards }}" name="public">
                                  <label style="padding-left: 55px;">Свободные</label>
                                </div>
                            </div>
                            {%endif%}
                            <div class="filter wide column">
                                <div class="filter-element">
                                    <div class="filter-title">Предметы <i class="icon caret down" style="float: right;"></i></div>
                                    <ul class="filter-list filter-list-hide">
                                        {% for subject_category in subject_categories %}
                                        <li class="filter-item filter-item-s" status="0" id="{{ subject_category.title|remove_space }}">
                                            {{subject_category.title}}
                                            <i class="icon check green" id="check_subject_category{{ subject_category.title }}"></i>                                            
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            {% if offices|length > 1 %}
                            <div class="filter wide column">
                                <div class="filter-element">
                                    <div class="filter-title">Офисы<i class="icon caret down" style="float: right;"></i></div>
                                    <ul class="filter-list filter-list-hide">
                                    {% for office in offices %}
                                        <li class="filter-item filter-item-s" status="0" id="{{ office.title }}">
                                            {{office.title}}
                                            <i class="icon check green" id="check_office{{ office.title }}"></i>
                                        </li>
                                    {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            {% endif %}
                            <div class="wide column" style="width: 60px;padding: 14px 0 0 0;">
                                <div class="filter-element">
                                    <div class="filter-title" style="padding-right: 1px;">Дни<i class="icon caret down" style="float: right;"></i></div>
                                    <ul class="filter-list filter-list-hide">
                                    {% for day in crmdays %}
                                        <li class="filter-item filter-item-s" status="0" id="day{{ day.id }}">
                                            {{day.title}}
                                            <i class="icon check green" id="check_day{{ day.title }}"></i>
                                        </li>
                                    {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            {% if is_director %}
                            <div class="wide column" style="padding-bottom: 0">
                                {% if all %}
                                <a class="ui button mini blue" style="padding: 8px;" href='{% url "schools:crm" %}'>Мои</a>
                                {% else %}
                                <a class="ui button mini blue" style="padding: 8px;" href='{% url "schools:crm_all" %}'>Все</a>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </form>
                </div>
                <div id="all_columns" style="height: 100%;">
                    <div class="ui grid" style="margin-top: -5px;height: 100%;">
                        {% for column in columns %}
                        <div class="wide column center aligned" style="padding: 3px;width: 16.65%;">
                            <div class="margin0 backdark" style="padding: 14px 4px;color: #fff;border-radius: 5px 5px 0 0;">
                                <div class="crm_title">{{ column.title }}</div>
                                <div class="crm_divider"></div>
                                <a class="ui button mini blue full-w" onclick="$('.new_card_form').modal('show');$('.add_card').attr('id', '{{ column.id }}')" id="{{column.id}}">Добавить</a>
                            </div>
                            <div class="column_scrollable backdark" page="2" id="{{column.id}}" style="height: 70%;overflow-x: hidden;">
                                <div class="ui active loader column_loader"></div>
                                <div class="textw" style="padding: 0 4px;">
                                    <div class="column{{ column.id }} crm_column">
                                        <draggable 
                                                class="crmbox{{ column.id }} full-h"
                                                :options="{group:{ name:'people'}}"
                                                @add="move_card({{ column.id }})">
                                        </draggable>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div id="school_schedule" class="school_schedule" status="closed">
                {% include 'school/register_students.html' %}
            </div>
        </div>
    </div>    
</div>
<div style="display: none;">
{% include 'school/card_details.html' %}
{% include 'school/schedule_lecture.html' %}
{% include 'school/new_card_form.html' %}
</div>
{% include 'school/card_form.html' %}
<div class="ui mini modal" id="delete_card_modal">
    <i class="close icon"></i>
    <div class="content">
        Вы уверены, что хотите удалить карточку?
        <br><br>
        <a class="yes_delete_card ui button mini green">Да</a>
        <a class="ui button mini red" onclick="$('#delete_card_modal').modal('hide')">Нет</a>
    </div>
</div>
<span style="display: none;" id="0" {%if crm_all%}all='yes'{%endif%} class="current_card" name="-1" url="{{ instance.open_card_url }}"></span>
<span style="display: none;" class="edit_card_url" url="{{ instance.edit_card_url }}"></span>
<span style="display: none;" class="add_card_url" url="{{ instance.add_card_url }}"></span>
<span style="display: none;" class="card_for_save" id="-1" predoplata_url="{{ instance.predoplata }}" url="{{ instance.save_card_as_user }}" get_card_squads="{{ instance.get_card_squads }}" get_card_info="{% url 'schools:get_card_info' %}"></span>
<span style="display: none;" class="first_column" id="{{ columns.0.id }}"></span>
<span style="display: none;" class="delete_card_data" id="-1" url="{{ instance.delete_card_url }}"></span>
<span class="data" is_dir="{{is_director}}" hisid="{{profile.id}}" get_schedule="{%url 'schools:get_schedule'%}" get_all_cards_first="{%url 'schools:get_all_cards_first'%}" get_all_cards_second="{%url 'schools:get_all_cards_second'%}" get_extra_cards="{%url 'schools:get_extra_cards'%}" send_login_url="{%url 'schools:send_login_url'%}" make_payment_card="{% url 'accounts:make_payment_card'%}" change_day_of_week="{% url 'schools:change_day_of_week'%}" search_crm_cards="{% url 'schools:search_crm_cards' %}" used_cards=""></span>
<script>{% include 'school/crm_scripts.html' %}</script>
<style type="text/css">
.ui-draggable-dragging{
    opacity: 1;
    width: 200px;
    z-index: 1000;
    transform: rotate(5deg);
}
.school_schedule {
  width: 0;
  padding: 14px 0 !important;
  position: absolute !important;
  z-index: 5000;
  right: 0;
  overflow-x: hidden;
  transition: 0.5s;
}
@media screen and (max-height: 450px) {
  .school_schedule {padding-top: 15px;}
  .school_schedule a {font-size: 18px;}
}
</style>

{% endblock content %}