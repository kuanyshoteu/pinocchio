{% load ttttags %}
{% load ttags %}
<div style="background-color: #4A4A4A;">
	<div class="ui grid" style="margin: 0;padding: 0 25px 0 0;">
		<div style="width: 25%;padding: 0;">
			<div style="text-align: left;color: white;height: 30px;line-height: 30px;">
		    </div>
			{% for student in att_squad.students.all %}
				<div class="student_name" style="{% if forloop.counter|is_odd %}background-color: #545454{% endif %}">
			        {{ student.first_name }}
			    </div>
			    <div class="ui divider grey_divider"></div>
			{% endfor %}
		</div>
		<div style="width: 75%;padding: 0;overflow: hidden">
			<div id="btn-prev" class="btn-prev" onclick="moverLeft()">&#60;</div>
			<div id="slider" class="slider" first_set="no" last_set="no" index="0">
				<div id="prev_atts" style="width: max-content;display: flex;"></div>
				{% for date in att_subject|get_current_attendance:att_squad %}
					<section class="slider__section">
						<div class="attendance_date{%if forloop.counter == 4%} last_att{%endif%} att{{forloop.counter}}" number="{{forloop.counter}}" id="{{date.0.subject_materials.id}}">
							{{ date.0.subject_materials|get_date:att_squad }}
						</div>
						{% for attendance in date %}
							{% include 'profile/attendance_block.html' %}
						{% endfor %}
					</section>
				{% endfor %}
				<div id="next_atts" style="width: max-content;display: flex;"></div>
			</div>
			<div id="btn-next" class="btn-next" onclick="moverRight()">&#62;</div>
		</div>
	</div>
</div>
<span class="more_attendance_url" url="{{ hisprofile.more_attendance }}" subject_id="{{att_subject.id}}" squad_id="{{att_squad.id}}" ></span>
<script type="text/javascript">
	//$('#slider .slider__section:last').insertBefore('#slider .slider__section:first');
	function createColumnRight(nextNumber){
		var url = $('.more_attendance_url').attr('url')
		var subject_id = $('.more_attendance_url').attr('subject_id')
		var squad_id = $('.more_attendance_url').attr('squad_id')
		sm = document.getElementsByClassName('attendance_date')
		last_sm = sm[document.getElementsByClassName('attendance_date').length-1].getAttribute('id')
		$.ajax({
            url: url,
            method: "GET",
            data: {
                'subject_id':subject_id,
                'squad_id':squad_id,
                'direction':'right',
                'sm_id':last_sm,
            },
            success: function (data) {
            	if(data.last_set){
	            	$('#slider').attr('last_set', 'yes')
            	}
            	for (var i = 0; i < data.columns.length; i++){
			        var section = createEl('section', 'slider__section');
			        console.log(nextNumber+i)
			        if (i == 0){
				        var div = createEl('div', 'attendance_date last_att att' + (nextNumber+i))
			        }
			        else{
				        var div = createEl('div', 'attendance_date att' + (nextNumber+i))			        	
			        }
			        div.setAttribute('number', nextNumber+i)
			        div.setAttribute('id', data.columns[i][1])
			        div.innerHTML = data.columns[i][0]
			        section.appendChild(div)
					document.getElementById('next_atts').appendChild(section)            		
            	}
            }, error: function (error) {
                console.log('error')
            }
        })
	}
	function createColumnLeft(prevNumber){
		var url = $('.more_attendance_url').attr('url')
		var subject_id = $('.more_attendance_url').attr('subject_id')
		var squad_id = $('.more_attendance_url').attr('squad_id')
		sm = document.getElementsByClassName('attendance_date')
		first_sm = sm[0].getAttribute('id')
		$.ajax({
            url: url,
            method: "GET",
            data: {
                'subject_id':subject_id,
                'squad_id':squad_id,
                'direction':'left',
                'sm_id':first_sm,
            },
            success: function (data) {
            	if(data.first_set){
	            	$('#slider').attr('first_set', 'yes')
            	}            	
            	for (var i = 0; i < data.columns.length ; i++){
			        var section = createEl('section', 'slider__section');
			        if (i > 0){
			        	section.setAttribute('style', 'display:none;')
                        section.setAttribute('id', 'section' + (i-prevNumber))
			        }
                    console.log('new', prevNumber-i)
			        var div = createEl('div', 'attendance_date att' + (prevNumber-i))
			        div.setAttribute('number', prevNumber-i)
			        div.setAttribute('id', data.columns[i][1])
			        div.innerHTML = data.columns[i][0]
			        section.appendChild(div)
                    prev_atts = document.getElementById('prev_atts')
					prev_atts.insertBefore(section, prev_atts.firstChild)            		
            	}
            }, error: function (error) {
                console.log('error')
            }
        })
	}
	function createEl(element, classname){
		var element = document.createElement(element)
        element.setAttribute('class', classname)
        return element
	}
	function moverRight() {
		var slider = $('#slider');
		var index = parseInt( slider.attr('index') )
		var length = document.getElementsByClassName('slider__section').length
		var last_set = $('#slider').attr('last_set')
		nextNumber = parseInt($('.last_att').attr('number')) + 1
		if($('.att' + nextNumber).length == 0 && last_set == "no"){
			createColumnRight(nextNumber);
		}
		if($('.att' + nextNumber).length > 0 || last_set == "no"){
			$('.last_att').attr('class', 'attendance_date att' + (nextNumber-1))
			index = index + 1;
			slider.animate({
				marginLeft:'-' + (index * 130) + 'px'
			} ,200, function(){
				slider.attr('index', index)
			});
			att = $('.att' + nextNumber)
			oldClass = att.attr('class')
			att.attr('class', oldClass + ' last_att')
		}
	}
	function moverLeft() {
		var slider = $('#slider');
		var index = parseInt( slider.attr('index') )
		var length = document.getElementsByClassName('slider__section').length
		var first_set = $('#slider').attr('first_set')
		prevNumber = parseInt($('.last_att').attr('number')) - 4

        action = false;
        console.log('length',$('.att' + prevNumber).length)
		if($('.att' + prevNumber).length == 0 && first_set == "no"){
            slider.animate({
                marginLeft:'-' + (index * 130) + 'px'
            } ,200, function(){
                console.log('created')
                createColumnLeft(prevNumber);
            });
            action = true;
		}
		else if($('.att' + (prevNumber)).length > 0 || first_set == "no"){
            console.log('moved', -prevNumber)
			if(index > 0){
				slider.animate({
					marginLeft:'-' + (index * 130) + 'px'
				} ,200, function(){
				});
			}
            action = true		
		}
        if (action) {
            index = index - 1;
            slider.attr('index', index)
            $("#section" + (-prevNumber)).attr('style', '')
            $('.last_att').attr('class', 'attendance_date att' + (prevNumber+4))
            att = $('.att' + (prevNumber+3))
            oldClass = att.attr('class')
            att.attr('class', oldClass + ' last_att')            
        }
	}
</script>
<style type="text/css">
.slider {
  display: flex;
  width: max-content;
}
.slider__section {
  width: 130px;
}
.btn-prev, .btn-next {
  width: 20px;
  height: 20px;
  background: rgba(255, 255, 255, 0.7);
  position: absolute;
  top: 95px;
  line-height: 20px;
  font-size: 11px;
  font-weight: bold;
  text-align: center;
  border-radius: 50%;
  font-family: monospace;
  cursor: pointer;
}
.btn-prev {
  left: 22%;
  background-color: #313a57;
  color:#fff;
}

.btn-next {
  right: 20px;
  background-color: #313a57;
  color:#fff;
}
</style>